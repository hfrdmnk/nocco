{{/* Photo card: Instagram-style with image, date, and location */}}
{{/* Extract first image from content */}}
{{ $image := "" }}
{{ $imageMatches := findRE `!\[.*?\]\((.*?)\)` .RawContent 1 }}
{{ with $imageMatches }}
	{{ $image = index . 0 | replaceRE `!\[.*?\]\(` "" | replaceRE `\)$` "" }}
{{ end }}

{{/* Also try HTML img tags */}}
{{ if not $image }}
	{{ $imgMatches := findRE `<img[^>]+src=["']([^"']+)["']` .RawContent 1 }}
	{{ with $imgMatches }}
		{{ $image = index . 0 | replaceRE `<img[^>]+src=["']` "" | replaceRE `["']$` "" }}
	{{ end }}
{{ end }}

{{/* Extract location: first non-empty text line after removing image */}}
{{ $location := "" }}
{{ $contentWithoutImage := .RawContent | replaceRE `!\[.*?\]\(.*?\)\s*` "" | replaceRE `<img[^>]*>\s*` "" }}
{{ $lines := split $contentWithoutImage "\n" }}
{{ range $lines }}
	{{ $trimmed := trim . " \r\n\t" }}
	{{ if and (not $location) $trimmed }}
		{{ $location = $trimmed }}
	{{ end }}
{{ end }}

<article class="card card--photo h-entry">
	{{ with $image }}
	<a href="{{ $.Permalink }}" class="card__image-link">
		<img src="{{ . }}" alt="" class="card__image u-photo">
	</a>
	{{ end }}
	<footer class="card__footer">
		<a href="{{ $.Permalink }}" class="card__date-link u-url">
			<time class="card__date dt-published" datetime="{{ .Date.Format "2006-01-02" }}">
				<span class="prefix">~</span>{{ .Date.Format "2 January 2006" }}
			</time>
		</a>
		{{ with $location }}
		<span class="card__location p-location">
			<span class="prefix">@</span>{{ . }}
		</span>
		{{ end }}
	</footer>
</article>
